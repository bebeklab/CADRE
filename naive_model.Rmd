---
title: "Prediction with melanoma"
output: html_document
date: "2023-07-20"
editor_options: 
  chunk_output_type: console
---
# Prepare data and environment
## Setting environment and define function
```{r}
options(scipen=999)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
requiredPackages2=c("Biobase","dplyr","fgsea","ggplot2","igraph","limma","parallel","pROC","tidyr")
for (k in requiredPackages2){
  if (!requireNamespace(k, quietly = TRUE)) BiocManager::install(k)
  suppressPackageStartupMessages(library(k,character.only = TRUE))
}
```
## Loading data and preprocessing
```{r}
DC_drug=read.csv("./data/drug_api.csv")
DC_drug <- DC_drug %>%
  mutate(stitch_name = ifelse(stitch_name == "" | is.na(stitch_name), dname, stitch_name))

DC_cell=read.csv("./data/cellline_api.csv")
DC_cell$name=gsub("[^a-zA-Z0-9]", "", toupper(DC_cell$name))
if (!exists("summary_df_ALMANAC")) {
summary_df_ALMANAC=read.csv("./data/summary_df_ALMANAC.csv")
}
if (!exists("summary_df_api")){
summary_df_api=read.csv("./data/summary_api.csv")
}
pathway_gene_set=gmtPathways("./data/c2.cp.kegg.v2023.1.Hs.symbols.gmt")
tissue_cancer_infosheet=read.csv(
"./data/ALMANAC_tissues_GSE116450_cancer.csv")
# example here used the 1st row of sheet, brain.
tissue_cancer_infosheet_temp=tissue_cancer_infosheet[9,]
tissue=tissue_cancer_infosheet_temp[1,1]
cancer=tissue_cancer_infosheet_temp[1,2]
```

## Define function
```{r}
order_2columns <- function(x){
  idx <- x[,1] > x[,2]
  x[idx, c(1,2)] <- x[idx, c(2,1)]
  return(x)
}

collapseProbes <- function (x
                            , method              = 'variance'
                            , topTable            = NULL
                            , colNameOfStat       = NULL
                            , colNameOfGeneSymbol = 'SYMBOL')
{
  # Validate parameters ----------
  if ( !(method %in% list('variance',
                          'logFC','P.Value',
                          'adj.P.Value')) ) {
    stop("Method ", paste(method, "not supported"))}
  # Make sure that a topTable is provided
  if (is.data.frame(topTable) ){
    # Check that the metric is one of the columns
    if(!(method %in% list("variance",
                          "logFC", "P.Value",
                          "adj.P.Value")) ) {
      stop("Method ", paste(method, "not supported") )}
    # Make sure the column name that has the gene symbol is provided
    if (!(colNameOfGeneSymbol %in% colnames(topTable)) ) {
      stop(paste(colNameOfGeneSymbol, 'must be a column in topTable'))
    }}
  if (!is.matrix(x))  {
    # Get Matrix from eset
    mat_exprs <- exprs(x)}
  if (method == 'variance') {
    cat("Processing eset using:",method,"\n")
    vec_variance  <- apply(mat_exprs,1,var)
    vec_symbol    <- fData(x)[rownames(mat_exprs),
                              colNameOfGeneSymbol]
    # Create a new data frame to cross reference
    df_xref      <- as.data.frame(cbind(mat_exprs, "variance"= vec_variance))
    # Attach the Symbols and the ProbIDs
    df_xref <- cbind(df_xref,"Gene Symbol"=vec_symbol,"probeID"=rownames(mat_exprs))
    # order by variance and find the unique SYMBOL list
    df_xref      <- df_xref[order(df_xref[[method]], decreasing=T),]
    uniqueGeneList  <- unique(df_xref[["Gene Symbol"]])
    # get first occurance, (highest variance)
    new_matrix    <- df_xref[match(uniqueGeneList,
                                   table = df_xref[["Gene Symbol"]]), ]
    # Update the eset
    x <- x[as.vector(new_matrix$probeID),]
    # Return the new eset
    esetToReturn <- x
  }else if (method == 'logFC') {
    cat("Processing eset using:",method,"\n")
    # order by logFC
    topTable <- topTable[order(topTable[[method]], decreasing = TRUE),]
    # subset the df_xref by the rows in the topTable, make sure that:
    #   nrows of df_xref match nrows of topTable
    df_xref <- df_xref[rownames(topTable),]
    # Check that they match
    if(!assertthat::are_equal(rownames(df_xref),rownames(topTable)) ) {
      stop("Matrix rows do not match topTable rows in method=logFC")
    }
    # Combine
    df_xref <- cbind(df_xref,topTable)
    df_xref[[colNameOfGeneSymbol]] <- df_xref[[colNameOfGeneSymbol]]
    # Order by method
    df_xref      <- df_xref[order(df_xref[[method]], decreasing=T),]
    uniqueGeneList  <- unique(df_xref[[colNameOfGeneSymbol]])
    # get first occurance, (highest variance) and create the new matrix
    new_matrix    <- df_xref[match(uniqueGeneList,
                                   table = df_xref[[colNameOfGeneSymbol]]), ]
    mat_exprs <- new_matrix[,colnames(mat_exprs)]
    rownames(mat_exprs) <- as.vector(new_matrix[[colNameOfGeneSymbol]])

    esetToReturn <- x[as.vector(new_matrix$probeID),]
    exprs(esetToReturn) <- as.matrix(mat_exprs)

    new_fData <- new_matrix[,c("Gene Symbol","variance","probeID")]
    rownames(new_fData)  <- new_fData[[colNameOfGeneSymbol]]

    fData(esetToReturn) <- new_fData

    assertthat::are_equal(rownames(exprs(esetToReturn)),
                          rownames(fData(esetToReturn)))}

  esetToReturn
}
```
# Create folders
```{r, warning=FALSE}
tissue_folder=paste0("./data/",tissue,"/")
dir.create(paste0(tissue_folder),recursive = TRUE)
dir.create(paste0(tissue_folder,"RDS"),recursive = TRUE)
dir.create(paste0(tissue_folder,"csv"),recursive = TRUE)
```
# Process summary data
## Filter by tissue, convert cell line name to stripped name
```{r}
ALMANAC_sub_tissue=subset(summary_df_ALMANAC,summary_df_ALMANAC$tissue_name==tissue)
ALMANAC_sub_tissue$cell_line_name=gsub("[^a-zA-Z0-9]", "", toupper(ALMANAC_sub_tissue$cell_line_name))
ALMANAC_sub_tissue2=subset(summary_df_api,summary_df_api$block_id %in% ALMANAC_sub_tissue$block_id)
```


## Convert drug ID to stitch name, cell ID to cell name, and convert cell name to upper case
```{r}
ALMANAC_sub_tissue_converted=ALMANAC_sub_tissue2
# Find matching indices in one step using 'match' function
drug_row_indices <- match(ALMANAC_sub_tissue_converted$drug_row_id, DC_drug$id)
drug_col_indices <- match(ALMANAC_sub_tissue_converted$drug_col_id, DC_drug$id)
cell_line_indices <- match(ALMANAC_sub_tissue_converted$cell_line_id, DC_cell$id)

# Replace NA values in temp vectors with the original id values
temp_row <- DC_drug$stitch_name[drug_row_indices]
temp_row[is.na(temp_row)] <- ALMANAC_sub_tissue_converted$drug_row_id[is.na(temp_row)]

temp_col <- DC_drug$stitch_name[drug_col_indices]
temp_col[is.na(temp_col)] <- ALMANAC_sub_tissue_converted$drug_col_id[is.na(temp_col)]
temp_cell_line <- DC_cell$name[cell_line_indices]

# Assign modified vectors back to the data frame
ALMANAC_sub_tissue_converted$drug_row_id <- temp_row
ALMANAC_sub_tissue_converted$drug_col_id <- temp_col
ALMANAC_sub_tissue_converted$cell_line_id <- temp_cell_line

# Convert cell name to upper case
ALMANAC_sub_tissue_converted$cell_line_id=toupper(ALMANAC_sub_tissue_converted$cell_line_id)
# remove drugs tested with self
ALMANAC_sub_tissue_converted=ALMANAC_sub_tissue_converted[ALMANAC_sub_tissue_converted$drug_row_id!=ALMANAC_sub_tissue_converted$drug_col_id,]
```


# Sensitivity classification
## Get all ri of all drug cell combination

```{r}
unique_cellnames <- unique(ALMANAC_sub_tissue_converted$cell_line_id)
unique_drugnames <- unique(c(ALMANAC_sub_tissue_converted$drug_row_id, ALMANAC_sub_tissue_converted$drug_col_id))
# Create an empty list to store results
ri_dataframe <- data.frame(
  cellname = character(), 
  drugname = character(), 
  ri_mean = numeric(), 
  stringsAsFactors = FALSE
)

for(cellname in unique_cellnames) {
  for(drugname in unique_drugnames) {
    # For data.frames, use the subset function or base R subsetting
    ri_rows <- ALMANAC_sub_tissue_converted[ALMANAC_sub_tissue_converted$drug_row_id == drugname & ALMANAC_sub_tissue_converted$cell_line_id == cellname, "ri_row"]
    ri_cols <- ALMANAC_sub_tissue_converted[ALMANAC_sub_tissue_converted$drug_col_id == drugname & ALMANAC_sub_tissue_converted$cell_line_id == cellname, "ri_col"]
    # Combine the subsets
    ri_list <- c(ri_rows, ri_cols)
    # Only compute mean if there are non-NA values
    if(length(na.omit(ri_list)) > 0) {
      ri_mean <- mean(na.omit(ri_list))
      ri_dataframe <- rbind(ri_dataframe, data.frame(cellname = cellname, drugname = drugname, ri_mean = ri_mean, stringsAsFactors = FALSE))
    }
  }
}

# Ensure that strings are not converted to factors
ri_dataframe$cellname <- as.character(ri_dataframe$cellname)
ri_dataframe$drugname <- as.character(ri_dataframe$drugname)
ri_dataframe=ri_dataframe[!is.na(ri_dataframe$ri_mean),]

compoundnames_unique=data.frame(stitch_name=names(table(ri_dataframe$drugname)))


saveRDS(compoundnames_unique,paste0(tissue_folder,"RDS","/compoundnames_unique.RDS"))
compoundnames_unique=readRDS(paste0(tissue_folder,"RDS","/compoundnames_unique.RDS"))
saveRDS(ri_dataframe, paste0(tissue_folder,"RDS","/ri_dataframe.RDS"))
ri_dataframe=readRDS( paste0(tissue_folder,"RDS","/ri_dataframe.RDS"))
```


## Classify synergy and antagonism, used ZIP, HAS, BLISS, for Tri-score
```{r}
score_sheet=data.frame(NULL)
# as thresholds in article
thresholds <- c(0, 5, 10, 15, 20, Inf)
share_synergy_list=list()
share_antagonism_list=list()


score_sheet <- data.frame(synergy_count = integer(5), antagonism_count = integer(5))
rownames(score_sheet) <- c("0-5", "5-10", "10-15", "15-20", "20>")
for (i in 1:(length(thresholds) - 1)) {
  lower_bound <- thresholds[i]
  upper_bound <- thresholds[i + 1]
  shared_synergy_melanoma_summary <- subset(ALMANAC_sub_tissue_converted, (synergy_zip > lower_bound  & synergy_hsa > lower_bound &synergy_bliss > lower_bound) & !(synergy_zip > upper_bound  & synergy_hsa > upper_bound & synergy_bliss > upper_bound))

  shared_antagonism_melanoma_summary <- subset(ALMANAC_sub_tissue_converted, (synergy_zip < - lower_bound  & synergy_hsa < - lower_bound &synergy_bliss < - lower_bound) & !(synergy_zip < - upper_bound & synergy_hsa < - upper_bound & synergy_bliss < - upper_bound))

  score_sheet[i,] <- c(dim(shared_synergy_melanoma_summary)[1], dim(shared_antagonism_melanoma_summary)[1])
  share_synergy_list[[i]]=shared_synergy_melanoma_summary
  share_antagonism_list[[i]]=shared_antagonism_melanoma_summary
}
print(score_sheet)
score_sheet=rbind(score_sheet,sumover5=c(sum(score_sheet[2:5,1]),sum(score_sheet[2:5,2])))
```

## Get Tri-score of drug combination-celline. Standardize for each combo.
```{r}
combination_tri_score = list()
for (i in 1:(nrow(compoundnames_unique) - 1)) {
  for (j in (i + 1):nrow(compoundnames_unique)) {
    
    num_cellline=dim(subset(ALMANAC_sub_tissue_converted,
                            (ALMANAC_sub_tissue_converted$drug_row_id== compoundnames_unique[i, 1] & ALMANAC_sub_tissue_converted$drug_col_id== compoundnames_unique[j, 1])|
                              (ALMANAC_sub_tissue_converted$drug_col_id== compoundnames_unique[i, 1] & ALMANAC_sub_tissue_converted$drug_row_id== compoundnames_unique[j, 1]
                              )))[1]
    if(num_cellline!=0){
      temp_sum=NULL
      for(h in 1:5){
        shared_synergy_melanoma_summary=share_synergy_list[[h]]
        temp <- subset(shared_synergy_melanoma_summary,
                       ((shared_synergy_melanoma_summary$drug_row_id == compoundnames_unique[i, 1]) &
                          (shared_synergy_melanoma_summary$drug_col_id == compoundnames_unique[j, 1])) |
                         ((shared_synergy_melanoma_summary$drug_col_id == compoundnames_unique[i, 1]) &
                            (shared_synergy_melanoma_summary$drug_row_id == compoundnames_unique[j, 1]))  )
        temp_sum=rbind(temp_sum,nrow(temp)*(h))
      }
      combination_tri_score[[length(combination_tri_score) + 1]] <- data.frame(
        drug1 = compoundnames_unique[i, 1],
        drug2 = compoundnames_unique[j, 1],
        score = sum(temp_sum) / (num_cellline / length(unique(ALMANAC_sub_tissue$cell_line_name))),
        stringsAsFactors = FALSE)
    }
    
  }
}
# Combine all data frames in the list into a single data frame
combination_tri_score <- bind_rows(combination_tri_score)
```


## Inspect distribution of Tri-score, and save scores to RDS
```{r}
# ggplot(combination_tri_score, aes(x=score)) +
#   geom_histogram(binwidth=1, color="black", fill="skyblue") +
#   labs(x="Value", y="Frequency", title="Histogram of Values") +
#   theme_minimal() 
table(combination_tri_score$score==0)
saveRDS(combination_tri_score,paste0(tissue_folder,"RDS","/drugcomb_synergy_Tri_score.RDS"))
```


# Use ri to classify sensitive/resistant. use ntile 3, from 9 cell lines, 3/3/3 for sensitivity
```{r, error = TRUE}
ri_drug_senres=data.frame(matrix(ncol=1+ncol(ri_dataframe),nrow=0))
colnames(ri_drug_senres)=c(colnames(ri_dataframe),"senres")
compoundnames_unique=data.frame(stitch_name=names(table(ri_dataframe$drugname)))
length(unique(ri_dataframe$cellname))
for (drug_nsc in compoundnames_unique[,1]){
    temp_senres=ri_dataframe[ri_dataframe$drugname==drug_nsc,]
    temp_senres=cbind(temp_senres,senres = ntile(temp_senres$ri_mean, 3))
    temp_senres$senres = if_else(temp_senres$senres == 3, 'sensitive', if_else(temp_senres$senres == 2, 'medium', 'resistant'))
    ri_drug_senres=rbind(ri_drug_senres,temp_senres)
}


rm(ri_dataframe)
table(ri_drug_senres[,4])

if (any(is.na(ri_drug_senres$senres))) {
  ri_drug_senres[is.na(ri_drug_senres$senres),]$senres <- 'medium'}

saveRDS(ri_drug_senres,paste0(tissue_folder,"RDS","/ri_drug_senres.RDS"))
ri_drug_senres=readRDS(paste0(tissue_folder,"RDS","/ri_drug_senres.RDS"))
```


# Get dysregulated pathways
## Get files from GEO
```{r introductionToGEO}
geoID1 <- 'GSE116450'
geo_folder <- file.path('./data/geo', geoID1 )
if (! file.exists(geo_folder) ) {
  dir.create(path = geo_folder,showWarnings = TRUE, recursive = TRUE)
  cat(geo_folder, 'created.\n\n')} else {
  cat(geo_folder, 'already exists\n\n')}

if (!file.exists("eset_GSE116450.RDS")) {
  if (!file.exists(geoID1)) {selected_gse <- GEOquery::getGEO(geoID1
                                     , destdir=geo_folder
                                     , GSEMatrix = TRUE
                                     , getGPL = TRUE)
    save(selected_gse, file=geoID1)} else{
    load(file=geoID1)}
  eset_selected <-selected_gse[[1]]
  eset_GSE116450 <- eset_selected
  saveRDS(eset_GSE116450, file="./data/geo/eset_GSE116450.RDS")} else{
  eset_GSE116450=readRDS("./data/geo//eset_GSE116450.RDS")}
pdata_GSE116450 <- pData(eset_GSE116450)
rm(geoID1, geo_folder, selected_gse, eset_selected)
```

## Collapse to reduce unnecessary probes
```{r collapseProbes, cache=FALSE}
eset.collapsed <- collapseProbes(x = eset_GSE116450
                                 , colNameOfGeneSymbol = "Gene Symbol"
                                 , method = "variance")

fData <- fData(eset.collapsed)
eset.collapsed <- eset.collapsed[!is.na(fData$`Gene Symbol`),] 
fData <- fData(eset.collapsed)
pData <- pData(eset.collapsed)
mat <- exprs(eset.collapsed)

if(!(assertthat::are_equal(rownames(fData), rownames(mat)) & 
     assertthat::are_equal(rownames(pData), colnames(mat))) ) {
  stop("fData or pData feature names does not match\n")
} else {
  cat("fData and pData match exprs matrix.")
}

rownames(mat) <- fData(eset.collapsed)$`Gene Symbol`
rownames(fData) <- fData(eset.collapsed)$`Gene Symbol`
eset.collapsed.symbol  <- ExpressionSet(assayData   = mat, 
                                        phenoData   = new("AnnotatedDataFrame",data = pData  ),
                                        featureData = new("AnnotatedDataFrame", data = fData), 
                                        annotation  = "illuminaHumanv4")

eset.collapsed.symbol <- eset.collapsed.symbol[!grepl(pattern = "LOC.*"
                                                      , x = rownames(exprs(eset.collapsed.symbol))), ]
eset.collapsed.symbol <- eset.collapsed.symbol[!grepl(pattern = "KIA.*"
                                                      , x = rownames(exprs(eset.collapsed.symbol))), ]
eset.collapsed.symbol <- eset.collapsed.symbol[!grepl(pattern = ".*orf.*"
                                                      , x = rownames(exprs(eset.collapsed.symbol))), ]

eset_GSE116450_collapsed=eset.collapsed.symbol
rm(eset.collapsed,eset.collapsed.symbol, fData, pData, mat)
```

## Specifying contrast for differential gene expression analysis
### Get testing group and normalize tissue name and time
```{r}
group_GSE116450=cbind(rownames(pdata_GSE116450),pdata_GSE116450$title,pdata_GSE116450$characteristics_ch1.1)
colnames(group_GSE116450)=c("GSM","title","tissue")
group_GSE116450=separate(data.frame(group_GSE116450),col=title,into=c("cell_line","drug","dose","time"),sep="_")
group_GSE116450$tissue <- gsub("tissue: ", "", group_GSE116450$tissue)
group_GSE116450$time <- gsub("^","t", group_GSE116450$time)

group_GSE116450_sub_tissue=subset(group_GSE116450,group_GSE116450$tissue==cancer&group_GSE116450$dose=="0nM")

title_tissue=list()
for (cell_line in unique(group_GSE116450_sub_tissue[,2]))
{
  for (time1 in c("2h","6h","24h"))
  {append_temp=paste(cell_line,"_topotecan_0nM_",time1,sep = "")
  title_tissue=append(title_tissue,append_temp)
  }
}
eset_GSE116450_sub_tissue=eset_GSE116450_collapsed[,pdata_GSE116450$title %in% title_tissue]
rm(eset_GSE116450_collapsed,title_tissue)

group_GSE116450_sub_tissue$cell_line=gsub("[^a-zA-Z0-9]", "",group_GSE116450_sub_tissue$cell_line )
group_GSE116450_sub_tissue$cell_line=gsub("LOX", "LOXIMVI",group_GSE116450_sub_tissue$cell_line)
group_GSE116450_sub_tissue$cell_line=gsub("HL60", "HL60TB",group_GSE116450_sub_tissue$cell_line)
```



## get dysruglated pathways of drugs
```{r, error = TRUE}

system.time({
# this step takes a lot of time
cl= makeCluster(detectCores() - 2)
clusterExport(cl, c("pathway_gene_set","compoundnames_unique","ri_drug_senres","group_GSE116450_sub_tissue","eset_GSE116450_sub_tissue"))

clusterEvalQ(cl, {requiredPackages2=c("parallel","limma","fgsea")
for (k in requiredPackages2){library(k,character.only = TRUE)}})
drug_interesting_pathway <- parLapply(cl, compoundnames_unique[,1], function(drug_nsc) {
  temp_senres=ri_drug_senres[ri_drug_senres$drugname==drug_nsc,]
  
  group_GSE116450_sub_tissue_temp=cbind(group_GSE116450_sub_tissue,senres=matrix(ncol=1,nrow=nrow(group_GSE116450_sub_tissue)))
  #get senres of a drug
  for (cell_line_1 in unique(temp_senres$cellname))
  {group_GSE116450_sub_tissue_temp[group_GSE116450_sub_tissue_temp[,2]==cell_line_1,7]=
      temp_senres[temp_senres$cellname==cell_line_1,4]}
  group_GSE116450_sub_tissue_temp$senres[is.na(group_GSE116450_sub_tissue_temp$senres)]="medium"
  temp_design=model.matrix( ~0 + group_GSE116450_sub_tissue_temp[['senres']])
  colnames(temp_design)=levels(as.factor(group_GSE116450_sub_tissue_temp[['senres']])) 
  contrast_matrix_temp <- makeContrasts(sensitive - resistant, levels=temp_design)
  
  fit_temp1 <- lmFit(eset_GSE116450_sub_tissue,temp_design)
  fit_temp2 <- contrasts.fit(fit_temp1,contrasts=contrast_matrix_temp)
  fit_temp2 <- eBayes(fit_temp2)
  
  # Calculate the ranking: -log10(p-value) * sign(log2FoldChange)
  geneRanks <- topTable(fit_temp2,number=Inf)
  geneRanks$rank = -log10(geneRanks$P.Value) * sign(geneRanks$logFC)
  
  # Order the genes by rank
  geneRanks=geneRanks[order(geneRanks$rank),]
  geneRanks1=geneRanks$rank
  names(geneRanks1) <- rownames(geneRanks)
  set.seed(42)
  fgseaRes_test1 <- fgsea(pathways = pathway_gene_set, 
                          stats = geneRanks1,
                          minSize=15,
                          maxSize=500,nPermSimple=100000,nproc=1)
  
  dysregulated_pathways <- subset(fgseaRes_test1, padj < 0.05)
  
  temp_list=dysregulated_pathways
  return(temp_list)
})
})

stopCluster(cl)
drug_interesting_pathway15=drug_interesting_pathway
names(drug_interesting_pathway)=compoundnames_unique[,1]
saveRDS(drug_interesting_pathway, file=
          paste0(tissue_folder,"RDS/interesting_pathway_kegg.RDS"))
drug_interesting_pathway=readRDS( paste0(tissue_folder,"RDS/interesting_pathway_kegg.RDS"))
rm(temp_senres)
```


## Check pahtway list acquired and remove empty ones
```{r}
names(drug_interesting_pathway)=compoundnames_unique[,1]
indices=1:length(drug_interesting_pathway)
indices2=indices
for(i in indices){
  indices2[i]=dim(drug_interesting_pathway[[i]])[1]
}
table(indices2==0)

drug_interesting_pathway=drug_interesting_pathway[!indices2==0]
rm(indices,indices2)
```


## put pathway list to a dataframe, and save it as csv
```{r}
pathway_list=data.frame(all_list=names(pathway_gene_set))
for (drug in names(drug_interesting_pathway))
{
  pathway_list[[drug]]=as.numeric(pathway_list$all_list %in% drug_interesting_pathway[[drug]]$pathway)
  
  result_vec <- integer(length(pathway_list$all_list))
  matched_indexes <- match(pathway_list$all_list, drug_interesting_pathway[[drug]]$pathway)
  non_na_indices <- which(!is.na(matched_indexes))
  
  result_vec[non_na_indices] <- ifelse(drug_interesting_pathway[[drug]]$NES[matched_indexes[non_na_indices]] > 0, 1, -1)
  pathway_list[[drug]]=result_vec
}
rm(result_vec,matched_indexes,non_na_indices)


drug_pathway_melanoma=pathway_list[,-1]
rownames(drug_pathway_melanoma)=pathway_list[,1]
write.csv(drug_pathway_melanoma,paste0(paste0(tissue_folder,"csv","/drug_pathway_",tissue,"_kegg.csv")))
```

# Graph generation
## Make graph property
```{r}
drug_pathway_melanoma=cbind("probes"=rownames(drug_pathway_melanoma),drug_pathway_melanoma)
property_data <- reshape2::melt(drug_pathway_melanoma, id.vars = "probes",variable.name = "Node", value.name = "Property")
# Adjust the dataframe so that rows with Property==0 are removed
property_data <- property_data[property_data$Property != 0, ]

property_data1=as.data.frame(cbind(paste0(property_data$probes, "_", property_data$Property),as.character(property_data$Node)))

colnames(property_data1)=c("property","node")
rm(drug_pathway_melanoma)
```

## Create an adjacency matrix from property_data
```{r, warning=FALSE}
### https://stackoverflow.com/questions/45003500/create-an-adjacency-matrix-or-list-based-on-shared-properties-from-a-data-frame
weight_drug_pathway_melanoma <- full_join(property_data1, property_data1, c('property' = 'property')) %>% 
  # We no longer need property -> remove
  dplyr::select(-property) %>% 
  # Dont allow self-loops
  filter(node.x != node.y) %>% 
  # Aggregate duplicate edges: vertices linked using multiple properties
  group_by(node.x, node.y) %>% 
  summarise(weight = n())

saveRDS(weight_drug_pathway_melanoma,file=paste0(tissue_folder,"RDS","/weight_drug_pathway_",tissue,"_kegg.RDS"))
```

## Form graph and save as RDS
```{r, error = TRUE}
graph_pathway <- graph_from_data_frame(weight_drug_pathway_melanoma, directed = FALSE)
graph_pathway=igraph::simplify(graph_pathway)
E(graph_pathway)$weight=E(graph_pathway)$weight/2

saveRDS(graph_pathway,file=paste0(tissue_folder,"RDS/graph_pathway_kegg.RDS"))
ggplot(as.data.frame(E(graph_pathway)$weight), aes(x=E(graph_pathway)$weight)) +
  geom_histogram(binwidth=1, color="black", fill="skyblue") +
  labs(x="Value", y="Frequency", title="Histogram of Values") +
  theme_minimal() 
# plot.igraph(graph_pathway, edge.label=round(E(graph_pathway)$weight, 3))
```


# Prediction by cluster
```{r}
threshold_graph=95
  ALmelanoma_sheet=readRDS(paste0(tissue_folder,"RDS/drugcomb_synergy_Tri_score.RDS"))[,1:2]
  ALmelanoma_sheet$appear=0
  ALmelanoma_sheet$synergy=0
  threshold_list=seq(0, 99, by=1)
  for (threshold_edge_vector in (threshold_graph+1):100){
    threshold_edge=threshold_list[threshold_edge_vector]
    
    combination_tri_score=readRDS(paste0(tissue_folder,"RDS/drugcomb_synergy_Tri_score.RDS"))
    
    graph_pathway=readRDS(paste0(tissue_folder,"RDS/graph_pathway_kegg.RDS"))
    if(length(E(graph_pathway))>400){
      threshold1=max(E(graph_pathway)$weight[ntile(E(graph_pathway)$weight, 100)==threshold_edge])
    }else{
      
      threshold1=as.numeric(quantile(E(graph_pathway)$weight,((length(E(graph_pathway))-(100-threshold_edge)*4)/length(E(graph_pathway)))))
    }
    graph_pathway_trim=delete.edges(graph_pathway, E(graph_pathway)[E(graph_pathway)$weight <= threshold1])
    graph_pathway_trim=delete.vertices(graph_pathway_trim, which(degree(graph_pathway_trim)<=0))
    
    set.seed(42) 
    clusters=cluster_walktrap(graph_pathway_trim)
    membership=as.data.frame(membership(clusters))
    cluster_results=data.frame(id=rownames(membership),cluster=membership[,1])
    
    nodes_index=data.frame(cbind(c(1:length(V(graph_pathway_trim)$name)[1]),V(graph_pathway_trim)$name))
    # Filter and replace elements in combination_tri_score
    combination_tri_score_filtered = subset(
      combination_tri_score,
      combination_tri_score$drug1 %in% nodes_index$X2 &
        combination_tri_score$drug2 %in% nodes_index$X2
    )
    cluster_names=names(table(cluster_results[,2]))
    ## loop within clusters to get the combination within same cluster.
    cluster_prediction=data.frame()
    # Fetch the edge list
    edge_list <- get.edgelist(graph_pathway_trim)
    # Fetch the weights
    edge_weights <- E(graph_pathway_trim)$weight
    # Create a data frame from the edge list and weights
    edge_info_df <- data.frame(
      from = edge_list[, 1],
      to = edge_list[, 2],
      weight = edge_weights
    )
    # Print the data frame
    edge_info_df=order_2columns(edge_info_df)
    # loop between clusters to get combinations
    for (i in 1:(length(cluster_names)-1)) {
      cluster_i = unlist(subset(cluster_results[,1], cluster_results[,2] == cluster_names[i]))
      # Loop through all other clusters
      for (j in (i + 1):length(cluster_names)) {
        cluster_j = unlist(subset(cluster_results[,1], cluster_results[,2] == cluster_names[j]))
        
        # Combining elements of cluster_i with elements of cluster_j
        combinations = as.data.frame(expand.grid(cluster_i, cluster_j))
        # Storing the combinations in the result data frame
        cluster_prediction = rbind(cluster_prediction, combinations)}}

    # Converting all factor columns to character
    cluster_prediction <- as.data.frame(lapply(cluster_prediction, function(x) {
      if (is.factor(x)) as.character(x) else x
    }))

    cluster_prediction=order_2columns(cluster_prediction)
    colnames(cluster_prediction)=c("drug1","drug2")
    
    ALmelanoma_sheet <- ALmelanoma_sheet %>%
      rowwise() %>%
      mutate(
        appear = if(any((combination_tri_score_filtered$drug1 == drug1) & (combination_tri_score_filtered$drug2 == drug2))) {
          appear + 1
        } else {
          appear
        }
      ) 
    ALmelanoma_sheet <- ALmelanoma_sheet %>%
      rowwise() %>%
      mutate(
        synergy = if(any((cluster_prediction$drug1 == drug1) & (cluster_prediction$drug2 == drug2))) {
          synergy + 1
        } else {
          synergy
        }
      ) 
  }
  
  ALmelanoma_sheet=ALmelanoma_sheet[ALmelanoma_sheet$appear!=0,]
  ALmelanoma_sheet$probability=ALmelanoma_sheet$synergy/(100-threshold_graph)
  probability_list=ALmelanoma_sheet
saveRDS(probability_list,paste0(tissue_folder,"RDS/probability_list_all.RDS"))
```
# Calculate AUROC
```{r}
probability_list=readRDS(paste0(tissue_folder,"RDS","/probability_list_all.RDS"))
combination_tri_score=readRDS(paste0(tissue_folder,"RDS","/drugcomb_synergy_Tri_score.RDS"))
prediction0 <- merge(probability_list, combination_tri_score, by = c("drug1", "drug2"))
length1=dim(prediction0)[1]

if(length1<500){synergy_threshold_list=quantile(prediction0$score,(length1-5)/length1)-0.01}else{
  synergy_threshold_list=(quantile(prediction0$score,  990/1000))}
prediction1=prediction0
synergy_threshold=synergy_threshold_list[1]
prediction1$score=ifelse(prediction1$score>synergy_threshold,1,0)
roc_obj <- roc(prediction1$score, prediction1$probability,levels=c(0,1),direction="<")
print(auc(roc_obj))
write.csv(prediction1,paste0(tissue_folder,"prediction.csv"))
```
# Session info
```{r}
sessionInfo()
```
